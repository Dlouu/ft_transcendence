<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        
        #log { 
            background: #f4f4f4; 
            padding: 10px; 
            border-radius: 5px; 
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .message { margin: 5px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; font-size: 0.9em; }
        .controls { margin-bottom: 20px; }
        input { padding: 5px; margin-right: 10px; }

        /* Room Info Panel Styling */
        #roomInfoPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
        }

        #roomInfoPanel h3 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 10px; font-size: 1.2em; }
        .info-row { margin-bottom: 8px; font-size: 14px; }
        .info-label { font-weight: bold; color: #555; display: block; margin-bottom: 2px; }
        .info-value-inline { float: right; color: #000; font-family: monospace; }
        .clear { clear: both; }
        
        /* Box for lists to support one-per-line and scrolling */
        .info-list-box {
            background: #f9f9f9; 
            padding: 8px; 
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 13px;
            max-height: 150px;
            overflow-y: auto;
        }

        .list-item {
            padding: 2px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        .list-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <h1>WebSocket Test</h1>
    
    <div class="controls">
        <label for="playerName">Player Name:</label>
        <input type="text" id="playerName" placeholder="Enter your name" value="test">
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
    </div>

    <!-- Right Top Room Info Panel -->
    <div id="roomInfoPanel">
        <h3>Room Infos</h3>
        
        <!-- Single values -->
        <div class="info-row">
            <span class="info-label" style="display:inline;">Room Name:</span>
            <span class="info-value-inline" id="ui-roomName">-</span>
            <div class="clear"></div>
        </div>
        
        <div class="info-row">
            <span class="info-label" style="display:inline;">Deck Cards:</span>
            <span class="info-value-inline" id="ui-deckCount">-</span>
            <div class="clear"></div>
        </div>
        
        <div class="info-row">
            <span class="info-label" style="display:inline;">Created At:</span>
            <span class="info-value-inline" id="ui-creationTime">-</span>
            <div class="clear"></div>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

        <!-- Lists -->
        <div class="info-row">
            <div class="info-label">Game Players (Hand Info):</div>
            <div id="ui-players" class="info-list-box">-</div>
        </div>

        <div class="info-row">
            <div class="info-label">Connected Clients:</div>
            <div id="ui-connected" class="info-list-box">-</div>
        </div>
    </div>

    <h2>Log:</h2>
    <div id="log"></div>

    <script>
        // UI Elements
        const logDiv = document.getElementById('log');
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const nameInput = document.getElementById('playerName');

        // Room Info Elements
        const uiRoomName = document.getElementById('ui-roomName');
        const uiDeckCount = document.getElementById('ui-deckCount');
        const uiCreationTime = document.getElementById('ui-creationTime');
        const uiPlayers = document.getElementById('ui-players');
        const uiConnected = document.getElementById('ui-connected');

        let socket;

        function log(message)
        {
            const div = document.createElement('div');
            div.className = 'message';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Helper to fill a list container with divs
        function updateListContainer(container, items)
        {
            container.innerHTML = ''; // Clear previous content
            
            if (!items || items.length === 0)
            {
                const div = document.createElement('div');
                div.textContent = 'None';
                div.style.color = '#999';
                div.style.fontStyle = 'italic';
                container.appendChild(div);
                return;
            }

            items.forEach(itemText => 
            {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.textContent = itemText;
                container.appendChild(div);
            });
        }

        // Helper to append a single item without clearing everything
        function appendToListContainer(container, itemText)
        {
            // If the current content is just "None" or "-", clear it first
            if (container.children.length > 0)
            {
                const firstChild = container.children[0];
                if (firstChild.textContent === 'None' || container.textContent === '-')
                {
                    container.innerHTML = '';
                }
            }

            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = itemText;
            container.appendChild(div);
        }

        function updateRoomInfo(wrapperData)
        {
            if (!wrapperData) return;

            const keys = Object.keys(wrapperData);
            if (keys.length === 0) return;
            const data = wrapperData[keys[0]];

            // 1. Room Name
            uiRoomName.textContent = data.roomName || 'Unknown';

            // 2. Deck Count
            if (data.deck && Array.isArray(data.deck))
            {
                uiDeckCount.textContent = data.deck.length;
            }
            else
            {
                uiDeckCount.textContent = '0';
            }
            
            // 3. Creation Time
            if (data.createdAt)
            {
                const date = new Date(data.createdAt);
                uiCreationTime.textContent = date.toLocaleTimeString();
            }
            else
            {
                uiCreationTime.textContent = '-';
            }

            // 4. Game Players list (Full refresh)
            let playerList = [];
            if (data.players && Array.isArray(data.players))
            {
                playerList = data.players.map(p => 
                {
                    let handSize = p._hand ? p._hand.length : 0;
                    let nameStr = `${p._name} [${handSize} cards]`;
                    if(p._isBot) nameStr += " (Bot)";
                    return nameStr;
                });
            }
            updateListContainer(uiPlayers, playerList);

            // 5. Connected Clients list (Full refresh)
            let connectedList = [];
            if (data.connectedPlayers)
            {
                const connectedObj = data.connectedPlayers;
                const entries = Object.entries(connectedObj);

                if (entries.length > 0)
                {
                    connectedList = entries.map(([key, value]) => 
                    {
                        if (typeof value === 'string') return value;
                        if (typeof value === 'object' && value !== null)
                        {
                            return value.name || value._name || key;
                        }
                        return key; 
                    });
                }
            }
            updateListContainer(uiConnected, connectedList);
        }

        connectBtn.addEventListener('click', () => 
        {
            const playerName = nameInput.value.trim();

            if (!playerName)
            {
                alert("Please enter a name first.");
                return;
            }

            socket = io('http://localhost:3000',
            {
                query:
                {
                    playerName: playerName
                }
            });

            socket.on('connect', () => 
            {
                log(`Connected as "${playerName}" with id: ${socket.id}`);
                connectBtn.disabled = true;
                nameInput.disabled = true;
                disconnectBtn.disabled = false;
            });

            // Standard complete update
            socket.on('TestJoin', (data) => 
            {
                updateRoomInfo(data);
            });

            // Specific event when a new player joins
            socket.on('playerJoined', (data) => 
            {
                log(`Event: playerJoined -> ${data.playerName}`);
                // Add this player to the connected list in the UI
                if (data && data.playerName)
                {
                    appendToListContainer(uiConnected, data.playerName);
                }
            });

            socket.on('disconnect', () => 
            {
                log('Disconnected');
                connectBtn.disabled = false;
                nameInput.disabled = false;
                disconnectBtn.disabled = true;
                
                uiRoomName.textContent = '-';
                uiDeckCount.textContent = '-';
                uiCreationTime.textContent = '-';
                uiPlayers.innerHTML = '-';
                uiConnected.innerHTML = '-';
            });

            socket.on('connect_error', (err) => 
            {
                log('Connection Error: ' + err.message);
                connectBtn.disabled = false;
                nameInput.disabled = false;
                disconnectBtn.disabled = true;
            });
        });

        disconnectBtn.addEventListener('click', () => 
        {
            if (socket) 
            {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
